<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forex Trading System - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/dashboard.css') }}" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="row header-section">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h1 class="text-center mb-3">
                            <i class="fas fa-chart-line text-primary"></i>
                            Forex Trading System
                        </h1>
                        <p class="text-center text-muted">5-Model Ensemble Analysis for EUR/USD and USD/JPY</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Account Settings -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-cog"></i> Account Settings</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <label for="accountSize" class="form-label">Account Size ($)</label>
                                <input type="number" class="form-control" id="accountSize" value="10000" min="100" step="100">
                            </div>
                            <div class="col-md-4">
                                <label for="riskPercent" class="form-label">Risk per Trade (%)</label>
                                <input type="number" class="form-control" id="riskPercent" value="1.5" min="0.5" max="5" step="0.1">
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-primary mt-4" onclick="refreshSignals()">
                                    <i class="fas fa-sync-alt"></i> Refresh Signals
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trading Signals -->
        <div class="row mt-4" id="signalsContainer">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3">Loading trading signals...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Dashboard -->
        <div class="row mt-4" id="performanceSection" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-bar"></i> Performance Tracking Dashboard</h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="performanceMetrics">
                            <!-- Performance metrics will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Last Updated -->
        <div class="row mt-3">
            <div class="col-12">
                <div class="text-center">
                    <small class="text-muted" id="lastUpdated">Last updated: Never</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let refreshInterval = null;
        let activeTabsState = {};
        
        // Load signals when page loads
        document.addEventListener('DOMContentLoaded', function() {
            refreshSignals();
            // Set up auto-refresh every 30 seconds
            refreshInterval = setInterval(refreshSignals, 30000);
        });

        async function refreshSignals() {
            const accountSize = document.getElementById('accountSize').value;
            const riskPercent = document.getElementById('riskPercent').value;
            
            // Save currently active tabs before refresh
            saveActiveTabStates();
            
            try {
                const response = await fetch(`/api/signals?account_size=${accountSize}&risk_percent=${riskPercent}`);
                const data = await response.json();
                
                if (data.success) {
                    displaySignals(data.data);
                    displayPerformance(data.performance);
                    document.getElementById('lastUpdated').textContent = 
                        `Last updated: ${new Date(data.timestamp).toLocaleString()}`;
                    
                    // Restore active tabs after content is updated
                    setTimeout(restoreActiveTabStates, 100);
                } else {
                    displayError(data.error || 'Unknown error occurred');
                }
            } catch (error) {
                displayError('Failed to fetch signals: ' + error.message);
            }
        }
        
        function saveActiveTabStates() {
            // Find all active tabs and save their state
            document.querySelectorAll('.nav-tabs .nav-link.active').forEach(tab => {
                const target = tab.getAttribute('data-bs-target');
                if (target) {
                    // Extract pair name from target (e.g., #analysis-EURUSD -> EURUSD)
                    const match = target.match(/-([A-Z]+)$/);
                    if (match) {
                        const pair = match[1];
                        // Extract tab type (analysis, risk, or timeframes)
                        const tabType = target.split('-')[0].substring(1);
                        activeTabsState[pair] = tabType;
                    }
                }
            });
        }
        
        function restoreActiveTabStates() {
            // Restore the active tab for each pair
            Object.entries(activeTabsState).forEach(([pair, tabType]) => {
                const tabId = `${tabType}-${pair}`;
                const tabButton = document.querySelector(`[data-bs-target="#${tabId}"]`);
                if (tabButton) {
                    const tab = new bootstrap.Tab(tabButton);
                    tab.show();
                }
            });
        }

        function displayPerformance(performance) {
            if (!performance || !performance.summary) return;
            
            const performanceSection = document.getElementById('performanceSection');
            const performanceMetrics = document.getElementById('performanceMetrics');
            
            const summary = performance.summary;
            const streak = performance.streak_info;
            
            performanceMetrics.innerHTML = `
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h4>${summary.win_rate}%</h4>
                            <p>Win Rate</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <h4>${summary.profit_factor}</h4>
                            <p>Profit Factor</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card ${streak.current >= 0 ? 'bg-success' : 'bg-danger'} text-white">
                        <div class="card-body text-center">
                            <h4>${streak.current >= 0 ? '+' : ''}${streak.current}</h4>
                            <p>Current Streak</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-secondary text-white">
                        <div class="card-body text-center">
                            <h4>${summary.total_trades}</h4>
                            <p>Total Trades</p>
                        </div>
                    </div>
                </div>
                <div class="col-12 mt-3">
                    <h6>📈 Performance: ${summary.win_rate}% win rate | Streak: ${streak.current >= 0 ? '+' : ''}${streak.current}</h6>
                </div>
            `;
            
            if (summary.total_trades > 0) {
                performanceSection.style.display = 'block';
            }
        }

        function displaySignals(signals) {
            const container = document.getElementById('signalsContainer');
            
            let html = '';
            
            Object.entries(signals).forEach(([pair, data]) => {
                if (data.error) {
                    html += createErrorCard(pair, data.error);
                } else {
                    html += createSignalCard(pair, data);
                }
            });
            
            container.innerHTML = html;
            
            // Add event listeners to track tab changes
            document.querySelectorAll('.nav-tabs .nav-link').forEach(tab => {
                tab.addEventListener('shown.bs.tab', function(event) {
                    saveActiveTabStates();
                });
            });
        }

        function createSignalCard(pair, data) {
            const signalClass = getSignalClass(data.signal);
            const signalIcon = getSignalIcon(data.signal);
            const confidenceClass = getConfidenceClass(data.confidence?.status || 'WEAK');
            const regimeIcon = getRegimeIcon(data.market_regime?.regime || 'UNKNOWN');
            
            return `
                <div class="col-md-6 mb-4">
                    <div class="card signal-card ${signalClass}">
                        <div class="card-header">
                            <h5 class="mb-0">
                                🎯 ${pair}: ${data.signal} 
                                <span class="badge ${confidenceClass} ms-2">(${data.confidence?.status || 'WEAK'})</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- Enhanced Signal Summary -->
                            <div class="enhanced-summary mb-3 p-3 rounded" style="background: rgba(0,0,0,0.05);">
                                <div class="row">
                                    <div class="col-md-12">
                                        <p class="mb-1"><strong>📊 Confidence:</strong> ${data.confidence?.percentage || 0}% (${Object.keys(data.model_votes).length}/5 models${data.timeframe_consensus ? ' + ' + data.timeframe_consensus.consensus + ' consensus' : ''})</p>
                                        <p class="mb-1"><strong>🏛️ Market Regime:</strong> ${regimeIcon} ${data.market_regime?.regime || 'UNKNOWN'} (ADX: ${data.market_regime?.adx || 0})</p>
                                        <p class="mb-1"><strong>💰 Dynamic SL:</strong> ${getSlTpDisplay(data, 'sl')} | <strong>TP:</strong> ${getSlTpDisplay(data, 'tp')} ${data.atr_value ? '(ATR: ' + data.atr_value.value + ')' : ''}</p>
                                        <p class="mb-1"><strong>⚡ Risk:</strong> ${data.risk_percent || 1.5}% | <strong>Position:</strong> ${data.position_size?.micro_lots || 0} micro lots</p>
                                        <p class="mb-0"><strong>🎯 Price Action:</strong> ${data.price_action?.price_position || 'Unknown'}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Detailed Analysis Tabs -->
                            <ul class="nav nav-tabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#analysis-${pair.replace('/', '')}" type="button">Analysis</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#risk-${pair.replace('/', '')}" type="button">Risk Mgmt</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#timeframes-${pair.replace('/', '')}" type="button">Timeframes</button>
                                </li>
                            </ul>
                            
                            <div class="tab-content mt-3">
                                <!-- Analysis Tab -->
                                <div class="tab-pane fade show active" id="analysis-${pair.replace('/', '')}" role="tabpanel">
                                    <div class="row">
                                        <div class="col-6">
                                            <h6>Current Price: <span class="price">${data.current_price}</span></h6>
                                            <div class="progress mb-2" style="height: 25px;">
                                                <div class="progress-bar bg-success" style="width: ${data.buy_probability}%">
                                                    Buy ${data.buy_probability}%
                                                </div>
                                                <div class="progress-bar bg-danger" style="width: ${data.sell_probability}%">
                                                    Sell ${data.sell_probability}%
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <h6>Market Regime</h6>
                                            <p><strong>Type:</strong> ${data.market_regime?.regime || 'Unknown'}</p>
                                            <p><strong>ADX:</strong> ${data.market_regime?.adx || 0} (${data.market_regime?.trend_strength || 'Unknown'})</p>
                                            <p><strong>Volatility:</strong> ${data.market_regime?.band_width || 0}%</p>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-3">
                                        <h6>Model Votes</h6>
                                        <div class="model-votes">
                                            ${Object.entries(data.model_votes).map(([model, vote]) => 
                                                `<span class="badge ${getVoteBadgeClass(vote)} me-1 mb-1">
                                                    ${formatModelName(model)}: ${getVoteText(vote)}
                                                </span>`
                                            ).join('')}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Risk Management Tab -->
                                <div class="tab-pane fade" id="risk-${pair.replace('/', '')}" role="tabpanel">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>Dynamic Levels ${data.calculation_method ? '(' + data.calculation_method + ')' : ''}</h6>
                                            <table class="table table-sm">
                                                <tr>
                                                    <td><strong>Stop Loss:</strong></td>
                                                    <td>
                                                        Buy: <span class="text-danger">${data.stop_loss?.buy}</span><br>
                                                        Sell: <span class="text-danger">${data.stop_loss?.sell}</span><br>
                                                        <small class="text-muted">(${data.stop_loss?.pips} pips)</small>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Take Profit:</strong></td>
                                                    <td>
                                                        Buy: <span class="text-success">${data.take_profit?.buy}</span><br>
                                                        Sell: <span class="text-success">${data.take_profit?.sell}</span><br>
                                                        <small class="text-muted">(${data.take_profit?.pips} pips)</small>
                                                    </td>
                                                </tr>
                                            </table>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>Position Sizing</h6>
                                            <table class="table table-sm">
                                                <tr>
                                                    <td>Micro Lots:</td>
                                                    <td><strong>${data.position_size?.micro_lots}</strong></td>
                                                </tr>
                                                <tr>
                                                    <td>Risk Amount:</td>
                                                    <td><strong>$${data.risk_amount}</strong></td>
                                                </tr>
                                                <tr>
                                                    <td>Units:</td>
                                                    <td>${data.position_size?.units?.toLocaleString()}</td>
                                                </tr>
                                                <tr>
                                                    <td>R:R Ratio:</td>
                                                    <td>${data.reward_risk_ratio || 'N/A'}:1</td>
                                                </tr>
                                            </table>
                                        </div>
                                    </div>
                                    
                                    ${data.atr_value ? `
                                    <div class="mt-2">
                                        <h6>ATR Information</h6>
                                        <p><strong>ATR Value:</strong> ${data.atr_value.value}</p>
                                        <p><strong>SL Distance:</strong> ${data.atr_value.value} × 1.5 = ${(data.atr_value.value * 1.5).toFixed(5)}</p>
                                        <p><strong>TP Distance:</strong> ${data.atr_value.value} × 3.0 = ${(data.atr_value.value * 3.0).toFixed(5)}</p>
                                    </div>
                                    ` : ''}
                                </div>
                                
                                <!-- Timeframes Tab -->
                                <div class="tab-pane fade" id="timeframes-${pair.replace('/', '')}" role="tabpanel">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>Multi-Timeframe Consensus</h6>
                                            <p><strong>Overall:</strong> <span class="badge ${getSignalClass(data.timeframe_consensus?.consensus || 'NEUTRAL')}">${data.timeframe_consensus?.consensus || 'NEUTRAL'}</span></p>
                                            <p><strong>Agreement:</strong> ${data.timeframe_consensus?.agreement || 0}%</p>
                                            
                                            <h6 class="mt-3">Timeframe Signals</h6>
                                            <div class="timeframe-signals">
                                                ${data.timeframe_consensus?.timeframe_signals ? 
                                                    Object.entries(data.timeframe_consensus.timeframe_signals).map(([tf, signal]) =>
                                                        `<span class="badge ${getSignalClass(signal)} me-1 mb-1">${tf}: ${signal}</span>`
                                                    ).join('') 
                                                    : '<span class="text-muted">No timeframe data</span>'
                                                }
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>Price Action Analysis</h6>
                                            <table class="table table-sm">
                                                <tr>
                                                    <td>Support:</td>
                                                    <td>${data.price_action?.support || 'N/A'}</td>
                                                </tr>
                                                <tr>
                                                    <td>Resistance:</td>
                                                    <td>${data.price_action?.resistance || 'N/A'}</td>
                                                </tr>
                                                <tr>
                                                    <td>Position:</td>
                                                    <td><span class="${data.price_action?.near_key_level ? 'text-warning' : 'text-success'}">${data.price_action?.price_position || 'Unknown'}</span></td>
                                                </tr>
                                                <tr>
                                                    <td>Doji Pattern:</td>
                                                    <td>${data.price_action?.doji_pattern ? '⚠️ Yes' : '✅ No'}</td>
                                                </tr>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function createErrorCard(pair, error) {
            return `
                <div class="col-md-6 mb-4">
                    <div class="card border-danger">
                        <div class="card-header bg-danger text-white">
                            <h5 class="mb-0">${pair} - Error</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-danger">${error}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function displayError(error) {
            const container = document.getElementById('signalsContainer');
            container.innerHTML = `
                <div class="col-12">
                    <div class="card border-danger">
                        <div class="card-body text-center">
                            <i class="fas fa-exclamation-triangle text-danger fa-2x mb-3"></i>
                            <h5 class="text-danger">Error Loading Signals</h5>
                            <p>${error}</p>
                            <button class="btn btn-outline-danger" onclick="refreshSignals()">
                                <i class="fas fa-retry"></i> Try Again
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function getSignalClass(signal) {
            switch(signal) {
                case 'BUY': return 'bg-success';
                case 'SELL': return 'bg-danger';
                default: return 'bg-warning';
            }
        }

        function getSignalIcon(signal) {
            switch(signal) {
                case 'BUY': return '<i class="fas fa-arrow-up"></i>';
                case 'SELL': return '<i class="fas fa-arrow-down"></i>';
                default: return '<i class="fas fa-pause"></i>';
            }
        }

        function getVoteBadgeClass(vote) {
            if (vote === 1) return 'bg-success';
            if (vote === -1) return 'bg-danger';
            return 'bg-secondary';
        }

        function getVoteText(vote) {
            if (vote === 1) return 'BUY';
            if (vote === -1) return 'SELL';
            return 'HOLD';
        }

        function formatModelName(model) {
            return model.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function getConfidenceClass(status) {
            switch(status) {
                case 'CONFIRMED': return 'bg-success';
                case 'LIKELY': return 'bg-info';
                case 'POSSIBLE': return 'bg-warning';
                default: return 'bg-secondary';
            }
        }

        function getRegimeIcon(regime) {
            switch(regime) {
                case 'TRENDING': return '📈';
                case 'RANGING': return '↔️';
                case 'VOLATILE': return '🌊';
                default: return '❓';
            }
        }

        function getSlTpDisplay(data, type) {
            const levels = type === 'sl' ? data.stop_loss : data.take_profit;
            if (!levels) return 'N/A';
            
            if (data.signal === 'BUY') {
                return levels.buy;
            } else if (data.signal === 'SELL') {
                return levels.sell;
            } else {
                return `${levels.buy}/${levels.sell}`;
            }
        }
    </script>
</body>
</html>